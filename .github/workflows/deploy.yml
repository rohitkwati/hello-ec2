name: Deploy Simple App to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      env:
        PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          set -e
          mkdir -p /home/ec2-user/my-app
          cd /home/ec2-user/my-app

          # clone or pull
          if [ ! -d .git ]; then
            git clone https://github.com/rohitkwati/hello-ec2.git .
          else
            git pull origin main
          fi

          npm install

          pkill node || true
          nohup npm start > log.txt 2>&1 &
        EOF
